---
title: "Avergae order"
author: "Camille Bergeron"
date: "5/2/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# librarires
library(dplyr)
library(tidyverse)
```

# Question 1

## Clenaing and Viewing 

```{r}
# looking at data 

# loading the data
orders <- read.csv("2019 Winter Data Science Intern Challenge Data Set - Sheet1.csv")

# avg order value
orders %>%
  select(order_amount) %>%
  summarise(n = mean(order_amount))

# looking at potential outliers
ggplot(orders) +
  geom_boxplot(aes(x = order_amount)) +
  labs(title = "Boxplot of Order Anount", x = "Order Amount")

# extracting the outliers
boxplot.stats(orders$order_amount)$out

orders[which(orders$order_amount == max(orders$order_amount)), ]
```

The largest outliers are all exactly $704000 by the same user at the same shop with the same payment method. The only difference is that the transactions take place on different days in March, but all at 4:00 am. 

```{r}
# new boxplot without the large order
orders %>%
  filter(user_id != 607) %>%
  ggplot() +
  geom_boxplot(aes(x = order_amount)) +
  labs(title = "Boxplot of Order Anount", x = "Order Amount", subtitle = "With the large outlier removed")
  # there are still lot of outliers so these clearly not it 

# looking at this average 
orders %>%
  filter(user_id != 607) %>%
  summarise(n = mean(order_amount))
# this is much cheaper, so maybe this is better? 

# separating the date and time 
orders <- orders %>%
  separate(created_at, c("date", "time"), " ") %>%
  mutate(date = as.Date(date)) 

# taking out the dates to see if they were closing out 
orders %>%
  filter(shop_id == 42) %>%
  arrange(date)

```

```{r}
# this is the average amount spent on items 
orders %>%
  mutate(avg = order_amount / total_items) %>%
  summarise(n = mean(avg))

```

Another way to do analysis similar to the average order value (AOV) is by looking at the overage value per item. This number is $387 per sneaker. 

# Question 2

## Part a: Orders Shipped by Speedy Express

__Notes:__
- Speedy Express is ShipperID 1

__SQL Query__

SELECT COUNT(*) FROM [Orders] WHERE ShipperID = (SELECT ShipperID FROM [Shippers] WHERE Shippers.ShipperName = "Speedy Express")

There are 54 orders shipped by Speedy Express

## Part b: Last Name of Employee with Most Orders

__SQL Query__

SELECT CustomerName 
FROM [Customers] 
WHERE CustomerID = (
  SELECT CustomerID
  FROM [Orders] 
  GROUP BY CustomerID 
  ORDER BY COUNT(CustomerID)
  DESC 
  LIMIT 1)

The last name of the customer with the most orders shipped is "Handel". The actual output of the previous code is "Ernst Handel". 

## Part c: Product Orderded moost from customers in Germany 

__SQL Query__

- this gets the proper customers from Germany

SELECT CustomerID 
FROM [Customers] 
WHERE Country = "Germany"

- this gets the associated orders from those customers 

SELECT OrderID 
FROM [Orders]
WHERE CustomerID IN (
  SELECT CustomerID 
  FROM [Customers] 
  WHERE Country = "Germany" 
)

- this gets the associated Product ids from the order identified order ids

SELECT ProductID 
FROM [OrderDetails] 
WHERE OrderID IN (
  SELECT OrderID FROM [Orders] 
  WHERE CustomerID IN (
    SELECT CustomerID 
    FROM [Customers]
    WHERE Country = "Germany"
  )
)

- this gets the most purchased productID

SELECT ProductID
FROM [OrderDetails] 
WHERE OrderID IN (
	SELECT OrderID 
	FROM [Orders] 
	WHERE CustomerID IN (
	  SELECT CustomerID 
	  FROM [Customers] 
	  WHERE Country = "Germany"
	)
)
GROUP BY ProductID 
ORDER BY COUNT(ProductID) DESC 
LIMIT 1


- this grabs the product name, and is the final query

SELECT ProductName 
FROM [Products] 
WHERE ProductID = (SELECT ProductID
  FROM [OrderDetails] 
  WHERE OrderID IN (
	  SELECT OrderID FROM [Orders] WHERE CustomerID IN (SELECT CustomerID FROM 		    [Customers] WHERE Country = "Germany"
	)
)
  GROUP BY ProductID 
  ORDER BY COUNT(ProductID) DESC 
  LIMIT 1
)
  
The most purchases product by customers in Germany is called Gorgonzola Telino. 
